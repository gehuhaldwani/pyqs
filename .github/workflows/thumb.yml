name: Generate Thumbnails

on:
  workflow_dispatch:

  push:
    branches:
      - main

concurrency:
  group: "thumbnails"
  cancel-in-progress: true

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 2

      - name: Checkout existing thumbnails
        uses: actions/checkout@v4
        with:
          ref: thumbnails
          path: thumbnails
        continue-on-error: true # First run won't have the branch yet

      - name: Install ImageMagick
        run: sudo apt-get install -y imagemagick

      - name: Detect changed PDFs and generate thumbnails
        run: |
          THUMBNAIL_SIZE="512x512"
          OUTPUT_DIR="thumbnails"
          mkdir -p "$OUTPUT_DIR"

          # On workflow_dispatch, regenerate all thumbnails
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger — regenerating all thumbnails."
            find . -path ./thumbnails -prune -o -type f -name "*.pdf" -print | while read -r pdf_file; do
              base_name=$(basename "$pdf_file" .pdf)
              dir_name=$(dirname "$pdf_file")
              output_subdir="$OUTPUT_DIR/$dir_name"
              mkdir -p "$output_subdir"
              (
                convert -thumbnail "$THUMBNAIL_SIZE" "$pdf_file"[0] "$output_subdir/$base_name.webp"
                echo "Generated: $output_subdir/$base_name.webp"
              ) &
            done
            wait
            echo "All thumbnails regenerated."
            exit 0
          fi

          # For push events, only process changed files
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR HEAD~1 HEAD -- '*.pdf' || true)
          DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1 HEAD -- '*.pdf' || true)

          if [[ -z "$CHANGED_FILES" && -z "$DELETED_FILES" ]]; then
            echo "No PDF changes detected — nothing to do."
            exit 0
          fi

          # Generate thumbnails for added/changed PDFs
          if [[ -n "$CHANGED_FILES" ]]; then
            echo "Generating thumbnails for changed PDFs:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" | while read -r pdf_file; do
              [[ -z "$pdf_file" ]] && continue
              base_name=$(basename "$pdf_file" .pdf)
              dir_name=$(dirname "$pdf_file")
              output_subdir="$OUTPUT_DIR/$dir_name"
              mkdir -p "$output_subdir"
              (
                convert -thumbnail "$THUMBNAIL_SIZE" "$pdf_file"[0] "$output_subdir/$base_name.webp"
                echo "Generated: $output_subdir/$base_name.webp"
              ) &
            done
            wait
          fi

          # Remove thumbnails for deleted PDFs
          if [[ -n "$DELETED_FILES" ]]; then
            echo "Removing thumbnails for deleted PDFs:"
            echo "$DELETED_FILES"
            echo "$DELETED_FILES" | while read -r pdf_file; do
              [[ -z "$pdf_file" ]] && continue
              base_name=$(basename "$pdf_file" .pdf)
              dir_name=$(dirname "$pdf_file")
              thumb_path="$OUTPUT_DIR/$dir_name/$base_name.webp"
              if [[ -f "$thumb_path" ]]; then
                rm "$thumb_path"
                echo "Removed: $thumb_path"
              fi
            done
          fi

          echo "Incremental thumbnail generation complete."

      - name: Push thumbnails to output branch
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: thumbnails
          build_dir: thumbnails
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
